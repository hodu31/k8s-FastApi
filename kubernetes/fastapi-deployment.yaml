apiVersion: apps/v1
kind: Deployment
metadata:
    name: fastapi-deployment
    namespace: minecraft-servers
spec:
    replicas: 1
    revisionHistoryLimit: 3
    selector:
        matchLabels:
            app: fastapi
    template:
        metadata:
            labels:
                app: fastapi
        spec:
            serviceAccountName: fastapi-sa
            
            priorityClassName: velocity-priority

            containers:
                - name: fastapi
                  # ê¹ƒí—ˆë¸Œ ì•¡ì…˜ì´ ë°°í¬í•  ë•Œ ìë™ìœ¼ë¡œ ìµœì‹  ì´ë¯¸ì§€ íƒœê·¸ë¡œ ë°”ê¿”ì¹˜ê¸° í•©ë‹ˆë‹¤.
                  # (ì§€ê¸ˆì€ latestë¡œ ë‘ì…”ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤)
                  image: de31/minecraft-fastapi:9c3364c6038fa773712050e142839001dfe88f2e
                  imagePullPolicy: Always
                  ports:
                      - containerPort: 8000
                  env:
                      - name: K8S_NAMESPACE
                        value: "minecraft-servers"
                      - name: GAME_DOMAIN
                        value: "mc.msdca.shop"
                      - name: API_DOMAIN
                        value: "mc.msdca.shop"
                      - name: NFS_SERVER
                        value: "100.75.219.111"
                      - name: NFS_BASE_PATH
                        value: "/mnt/nfs-minecraft"

                      # ê¸°ì¡´ API í‚¤ ì„¤ì •
                      - name: INTERNAL_API_KEY
                        valueFrom:
                            secretKeyRef:
                                name: fastapi-secrets
                                key: api-key

                      # ğŸ‘‡ [ì¶”ê°€ëœ ë¶€ë¶„] íŒŒì´ì¬ ì—ëŸ¬ í•´ê²°ì„ ìœ„í•œ ë²¨ë¡œì‹œí‹° ì‹œí¬ë¦¿ ì—°ê²°!
                      - name: VELOCITY_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: fastapi-secrets # ì¿ ë²„ë„¤í‹°ìŠ¤ ì‹œí¬ë¦¿ ì´ë¦„
                                key: velocity-forwarding-secret # ì‹œí¬ë¦¿ ì•ˆì— ë“¤ì–´ìˆëŠ” ì—´ì‡  ì´ë¦„

                  resources:
                      requests:
                          cpu: 500m
                          memory: 512Mi
                      limits:
                          cpu: 2
                          memory: 2Gi
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: 8000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                  readinessProbe:
                      httpGet:
                          path: /health
                          port: 8000
                      initialDelaySeconds: 10
                      periodSeconds: 5
