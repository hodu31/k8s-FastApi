apiVersion: apps/v1
kind: Deployment
metadata:
  name: velocity
  namespace: minecraft-servers
  labels:
    app: velocity
spec:
  replicas: 1  
  selector:
    matchLabels:
      app: velocity
  template:
    metadata:
      labels:
        app: velocity
    spec:
      serviceAccountName: velocity-sa
      nodeSelector:
        kubernetes.io/hostname: worker03
      
      initContainers:
      - name: download-plugin
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          echo "Downloading Plugins..."
              
          # 1. SubdomainRouter (ê¸°ì¡´ ìœ ì§€)
          echo "Downloading SubdomainRouterEnhanced..."
          curl -L -o /plugins/SubdomainRouterEnhanced-2.0.0.jar \
            https://github.com/hodu31/velocity-plugins/releases/download/v2.0.0/SubdomainRouterEnhanced-2.0.0.jar
          
          # 2. [ìˆ˜ì •ë¨] LimboAPI (ê²€ì¦ëœ ìµœì‹  ë²„ì „ 1.1.26)
          echo "Downloading LimboAPI 1.1.26..."
          curl -L -o /plugins/LimboAPI.jar \
            https://github.com/Elytrium/LimboAPI/releases/download/1.1.26/limboapi-1.1.26.jar

          # 3. [ìˆ˜ì •ë¨] LimboFilter (ê²€ì¦ëœ ìµœì‹  ë²„ì „ 1.1.18)
          echo "Downloading LimboFilter 1.1.18..."
          curl -L -o /plugins/LimboFilter.jar \
            https://github.com/Elytrium/LimboFilter/releases/download/1.1.18/limbofilter-1.1.18.jar
        
          # 4. [ì¶”ê°€ë¨] TCPShield (RealIP ë³µì›ìš©)
          echo "Downloading TCPShield..."
          curl -L -o /plugins/TCPShield.jar \
            https://github.com/TCPShield/RealIP/releases/download/2.7.2/TCPShield-2.7.2.jar

          echo "Download complete!"
          ls -lh /plugins/
        volumeMounts:
        - name: plugins-volume
          mountPath: /plugins
      
      # í”ŒëŸ¬ê·¸ì¸ ì„¤ì • íŒŒì¼ ë³µì‚¬
      - name: copy-plugin-config
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Creating plugin config directory..."
          mkdir -p /server/plugins/subdomain-router
          echo "Copying plugin config..."
          cp /plugin-config/config.yml /server/plugins/subdomain-router/config.yml
          echo "Config copied successfully!"
        volumeMounts:
        - name: plugins-volume
          mountPath: /server/plugins
        - name: plugin-config-volume
          mountPath: /plugin-config
      
      # ðŸ‘‡ [ìˆ˜ì •ë¨] í•˜ë“œì½”ë”© ì œê±°í•˜ê³  Secretì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½!
      - name: set-forwarding-secret
        image: busybox:1.36
        env:
          - name: FORWARDING_SECRET
            valueFrom:
              secretKeyRef:
                name: fastapi-secrets           # ì•„ê¹Œ ë§Œë“  ì‹œí¬ë¦¿ ì´ë¦„
                key: velocity-forwarding-secret # ì‹œí¬ë¦¿ ì•ˆì— ìžˆëŠ” í‚¤ ì´ë¦„
        command:
        - sh
        - -c
        - |
          echo "Setting forwarding secret form Kubernetes Secret..."
          # í™˜ê²½ë³€ìˆ˜($FORWARDING_SECRET)ë¥¼ íŒŒì¼ë¡œ ì”ë‹ˆë‹¤.
          echo "$FORWARDING_SECRET" > /server/forwarding.secret
          echo "Secret set successfully!"
        volumeMounts:
        - name: data-volume
          mountPath: /server
          
      containers:
      - name: velocity
        image: itzg/mc-proxy:java17
        ports:
        - name: velocity-port
          containerPort: 25577
        env:
        - name: TYPE
          value: "VELOCITY"
        - name: VELOCITY_VERSION
          value: "3.3.0-SNAPSHOT"
        - name: MEMORY
          value: "1G"
        volumeMounts:
        - name: data-volume
          mountPath: /server
        - name: plugins-volume
          mountPath: /server/plugins
        - name: config-volume
          mountPath: /config/velocity.toml
          subPath: velocity.toml
          
      volumes:
      - name: plugins-volume
        emptyDir: {}
      - name: config-volume
        configMap:
          name: velocity-config
      - name: data-volume
        emptyDir: {}
      - name: plugin-config-volume
        configMap:
          name: subdomain-router-config