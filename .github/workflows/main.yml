name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]  # main ë¸Œëœì¹˜ì— ì½”ë“œê°€ ì˜¬ë¼ì˜¤ë©´ ì‹¤í–‰

# ğŸ” ê¶Œí•œ ì„¤ì • (ì´ê²Œ ìˆì–´ì•¼ ë¡œë´‡ì´ deployment.yamlì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŒ)
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸ (Settings > Secretsì— ë“±ë¡ëœ ì •ë³´ ì‚¬ìš©)
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    # latest íƒœê·¸ì™€ ì»¤ë°‹ í•´ì‹œ(github.sha) íƒœê·¸ ë‘ ê°€ì§€ë¥¼ ëª¨ë‘ ë§Œë“­ë‹ˆë‹¤.
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/minecraft-fastapi:latest
          ${{ secrets.DOCKER_USERNAME }}/minecraft-fastapi:${{ github.sha }}

    # 4. Kubernetes ë°°í¬ íŒŒì¼(deployment.yaml)ì˜ ì´ë¯¸ì§€ íƒœê·¸ ìˆ˜ì • í›„ Git Push
    # ë„ì»¤ í‘¸ì‹œê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    - name: Update Kubernetes Manifest
      run: |
        # Git ì‚¬ìš©ì ì„¤ì • (GitHub Actions ë´‡ ì´ë¦„ìœ¼ë¡œ ì„¤ì •)
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # âš ï¸ [ì¤‘ìš”] ìˆ˜ì •í•  íŒŒì¼ ê²½ë¡œë¥¼ ì •í™•íˆ ì ì–´ì£¼ì„¸ìš”!
        # ë§Œì•½ íŒŒì¼ì´ 'k8s' í´ë” ì•ˆì— ìˆë‹¤ë©´ "k8s/deployment.yaml"ë¡œ ê³ ì³ì•¼ í•©ë‹ˆë‹¤.
        DEPLOYMENT_FILE="kubernetes/fastapi-deployment.yaml"
        
        # sed ëª…ë ¹ì–´ë¡œ deployment.yaml ì•ˆì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ í˜„ì¬ ì»¤ë°‹ í•´ì‹œë¡œ êµì²´
        # ì˜ˆ: image: de31/minecraft-fastapi:v2 -> image: de31/minecraft-fastapi:a1b2c3...
        sed -i "s|image: ${{ secrets.DOCKER_USERNAME }}/minecraft-fastapi:.*|image: ${{ secrets.DOCKER_USERNAME }}/minecraft-fastapi:${{ github.sha }}|g" $DEPLOYMENT_FILE
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        git add $DEPLOYMENT_FILE
        
        # ì‹¤ì œë¡œ ë³€ê²½ëœ ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹í•˜ê³  í‘¸ì‹œ (ì—ëŸ¬ ë°©ì§€)
        if ! git diff-index --quiet HEAD; then
          git commit -m "Update deployment image tag to ${{ github.sha }}"
          git push
        else
          echo "No changes to commit"
        fi
